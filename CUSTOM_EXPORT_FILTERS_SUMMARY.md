# Реализация фильтров для кастомного экспорта

## Что было сделано

### 1. Обновлено представление `CustomExportView`
- Добавлен метод `get_filter_data()` для получения данных фильтров из БД
- Обновлен метод `get_context_data()` для передачи данных фильтров в шаблон
- Обновлен метод `save_template()` для сохранения значений фильтров в шаблонах

### 2. Обновлен HTML шаблон `custom_export.html`
- Добавлена передача данных фильтров в JavaScript: `const filterData = {{ filter_data|safe }};`
- Полностью переписана функция `updateFilters()` с поддержкой источников данных
- Обновлена функция `loadTemplate()` для загрузки сохраненных фильтров
- Обновлена функция `saveTemplate()` для сохранения значений фильтров

### 3. Реализованы фильтры для источников данных

#### Полисы (policies):
- **Текстовые поля**: Номер полиса, Номер ДФА, Клиент
- **Выпадающие списки**: Страховщик, Филиал, Тип страхования
- **Даты**: Дата начала (от/до), Дата окончания (от/до)
- **Статусы**: Статус полиса, Статус ДФА, Участие брокера
- **Финансовые поля**: Общая премия, Франшиза
- **Дополнительные поля**: Дата расторжения

#### Платежи (payments):
- **Текстовые поля**: Номер полиса, Клиент
- **Выпадающие списки**: Страховщик, Филиал
- **Даты**: Дата платежа (от/до)
- **Числовые поля**: Год платежа (1-10), Номер платежа (1-12)
- **Статус**: Статус оплаты

## Технические детали

### Источники данных для фильтров:
- **Филиалы**: `apps.insurers.models.Branch`
- **Страховщики**: `apps.insurers.models.Insurer`
- **Типы страхования**: `apps.insurers.models.InsuranceType`

### Обработка ошибок:
- Добавлена обработка исключений в `get_filter_data()`
- При ошибке возвращаются пустые массивы

### Сохранение и загрузка шаблонов:
- Фильтры сохраняются в поле `config` модели `CustomExportTemplate`
- При загрузке шаблона фильтры автоматически применяются к форме

## Как использовать

1. **Выберите источник данных** (полисы или платежи)
2. **Выберите нужные поля** для экспорта
3. **Примените фильтры** для отбора данных:
   - Заполните текстовые поля для поиска по части
   - Выберите значения из выпадающих списков
   - Укажите диапазоны дат
   - Выберите статусы
4. **Экспортируйте данные** или **сохраните как шаблон** для повторного использования

## Изменения в версии 2.0

- **Убраны источники данных "Клиенты" и "Страховщики"** - они не нужны для экспорта
- Оставлены только **"Полисы"** и **"Платежи"** как основные источники данных
- Упрощен интерфейс и код за счет удаления неиспользуемых компонентов

## Изменения в версии 2.1

- **Убрано поле "Стоимость имущества"** из источника данных "Полисы"
- Поле удалено как из кастомного экспорта, так и из CSV экспорта полисов
- Это поле больше не используется в системе (данные перенесены в insurance_sum в платежах)

Кастомный экспорт теперь сфокусирован на актуальных полях и готов к использованию!
