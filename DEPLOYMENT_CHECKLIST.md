# Контрольный список первоначального развертывания

Используйте этот контрольный список для отслеживания прогресса первоначального развертывания на Digital Ocean.

## Предварительные требования

- [ ] Создан аккаунт на Digital Ocean
- [ ] Создан Droplet (Ubuntu 22.04, минимум 2GB RAM)
- [ ] IP адрес Droplet: `64.227.75.233`
- [ ] Установлены Docker и Docker Compose на Droplet
- [ ] Настроен firewall (UFW) - разрешены порты 22, 80, 443
- [ ] Настроены SSH ключи для доступа к Droplet
- [ ] DNS настроен для onbr.site и www.onbr.site
- [ ] DNS распространился (проверено через `dig onbr.site`)

## Шаг 1: Копирование файлов на Droplet

- [ ] Создана директория `/opt/insurance_broker` на Droplet
- [ ] Скопированы все файлы приложения на Droplet
- [ ] Проверена структура директорий (nginx, certbot, scripts, etc.)

**Команда:**
```bash
./scripts/initial-deploy.sh
# или вручную через rsync/scp
```

## Шаг 2: Создание .env.prod с production переменными

- [ ] Сгенерирован SECRET_KEY
- [ ] Сгенерирован DB_PASSWORD
- [ ] Создан файл .env.prod с правильными значениями
- [ ] Создан файл .env.prod.db
- [ ] Установлены права доступа 600 на .env файлы
- [ ] Сохранены пароли в безопасном месте

**Сгенерированные пароли (сохраните!):**
```
SECRET_KEY: _________________________________
DB_PASSWORD: _________________________________
```

## Шаг 3: Запуск docker-compose

- [ ] Запущены все контейнеры: `docker compose -f docker-compose.prod.yml up -d`
- [ ] Проверен статус контейнеров: все в статусе "Up"
- [ ] Выполнены миграции базы данных
- [ ] Собраны статические файлы
- [ ] Проверены логи на наличие ошибок

**Статус контейнеров:**
```
web:           [ ] Up
db:            [ ] Up (healthy)
redis:         [ ] Up (healthy)
nginx:         [ ] Up
celery_worker: [ ] Up
celery_beat:   [ ] Up
```

## Шаг 4: Получение SSL сертификата через Let's Encrypt

- [ ] Проверено, что DNS указывает на правильный IP
- [ ] Проверено, что порты 80 и 443 открыты
- [ ] Запущен скрипт `./scripts/init-letsencrypt.sh`
- [ ] SSL сертификат успешно получен
- [ ] Проверены файлы сертификата в `certbot/conf/live/onbr.site/`

**Срок действия сертификата:** `___________________`

## Шаг 5: Обновление Nginx конфигурации для HTTPS

- [ ] Nginx конфигурация обновлена для использования SSL
- [ ] Проверена конфигурация: `nginx -t` прошла успешно
- [ ] Nginx перезапущен
- [ ] Проверены логи Nginx на наличие ошибок

## Шаг 6: Проверка доступности сайта

- [ ] HTTP редиректит на HTTPS (проверено через `curl -I http://onbr.site`)
- [ ] HTTPS работает (проверено через `curl -I https://onbr.site`)
- [ ] Сайт открывается в браузере: https://onbr.site
- [ ] Нет предупреждений о сертификате в браузере
- [ ] Статические файлы загружаются корректно
- [ ] Админ панель доступна: https://onbr.site/admin/

## Шаг 7: Финальная настройка

- [ ] Создан суперпользователь Django
- [ ] Загружены начальные данные (если есть)
- [ ] Проверена работа Celery worker
- [ ] Проверена работа Celery beat
- [ ] Проверено подключение к базе данных
- [ ] Проверено логирование

## Проверка работоспособности

### Контейнеры
- [ ] Все контейнеры запущены и работают
- [ ] Нет постоянно перезапускающихся контейнеров
- [ ] Логи не содержат критических ошибок

### База данных
- [ ] PostgreSQL работает и доступен
- [ ] Миграции применены успешно
- [ ] Можно подключиться к БД из web контейнера

### Веб-приложение
- [ ] Главная страница загружается
- [ ] Админ панель доступна
- [ ] Можно войти под суперпользователем
- [ ] Статические файлы отображаются
- [ ] Нет ошибок 500 в логах

### SSL/HTTPS
- [ ] SSL сертификат валиден
- [ ] HTTP редиректит на HTTPS
- [ ] Нет предупреждений о безопасности
- [ ] HSTS заголовки установлены

### Celery
- [ ] Celery worker запущен и обрабатывает задачи
- [ ] Celery beat запущен и планирует задачи
- [ ] Redis доступен как брокер сообщений

## Следующие шаги

- [ ] Настроить GitHub Secrets для CI/CD (Task 20)
  - [ ] SSH_PRIVATE_KEY
  - [ ] DROPLET_HOST
  - [ ] DROPLET_USER
  - [ ] Другие необходимые секреты

- [ ] Протестировать автоматический деплой (Task 21)
  - [ ] Сделать тестовый коммит
  - [ ] Проверить запуск GitHub Actions
  - [ ] Проверить успешный деплой

- [ ] Настроить мониторинг
  - [ ] Настроить алерты
  - [ ] Настроить сбор метрик

- [ ] Настроить бэкапы
  - [ ] Автоматические бэкапы БД
  - [ ] Бэкапы медиа файлов
  - [ ] Проверить восстановление из бэкапа

## Troubleshooting

Если что-то пошло не так, проверьте:

### Контейнеры не запускаются
```bash
docker compose -f docker-compose.prod.yml logs
docker compose -f docker-compose.prod.yml ps
```

### SSL сертификат не получается
```bash
# Проверить DNS
dig onbr.site +short

# Проверить firewall
sudo ufw status

# Попробовать staging
STAGING=1 ./scripts/init-letsencrypt.sh
```

### Статические файлы не загружаются
```bash
docker compose -f docker-compose.prod.yml exec web python manage.py collectstatic --noinput --clear
docker compose -f docker-compose.prod.yml restart nginx
```

### Ошибки базы данных
```bash
docker compose -f docker-compose.prod.yml logs db
docker compose -f docker-compose.prod.yml exec web python manage.py check --database default
```

## Полезные команды

```bash
# Просмотр статуса
docker compose -f docker-compose.prod.yml ps

# Просмотр логов
docker compose -f docker-compose.prod.yml logs -f [service]

# Перезапуск сервиса
docker compose -f docker-compose.prod.yml restart [service]

# Выполнение команды Django
docker compose -f docker-compose.prod.yml exec web python manage.py [command]

# Проверка использования ресурсов
docker stats
```

## Контактная информация

**Droplet IP:** `64.227.75.233`
**Домен:** onbr.site
**SSH пользователь:** root
**Директория приложения:** /opt/insurance_broker

**Дата развертывания:** `___________________`
**Развернул:** `___________________`

---

## Примечания

Используйте это пространство для заметок о развертывании:

```
_________________________________________________________________

_________________________________________________________________

_________________________________________________________________

_________________________________________________________________

_________________________________________________________________
```

---

**Статус развертывания:** [ ] В процессе  [ ] Завершено  [ ] Требует внимания

**Последнее обновление:** `___________________`
