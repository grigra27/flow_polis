# Руководство по миграции на Timeweb Cloud

## Обзор

Это руководство описывает процесс настройки GitHub Secrets для автоматического развертывания Insurance Broker System на новом сервере Timeweb Cloud.

## Предварительные требования

Перед началом убедитесь, что у вас есть:
- Доступ к настройкам репозитория GitHub (права администратора)
- Доступ к серверу Timeweb Cloud (IP: 109.68.215.223)
- SSH клиент на вашем компьютере

## Необходимые GitHub Secrets

Для успешного развертывания необходимо настроить следующие секреты:

| Имя секрета | Описание | Новое значение |
|-------------|----------|----------------|
| `DROPLET_HOST` | IP адрес сервера Timeweb Cloud | `109.68.215.223` |
| `DROPLET_USER` | Имя пользователя для SSH подключения | `root` (или другой пользователь) |
| `SSH_PRIVATE_KEY` | Приватный SSH ключ для аутентификации | Сгенерированный ключ |

---

## Шаг 1: Генерация SSH ключей

### 1.1 Создание новой пары ключей

На вашем локальном компьютере выполните следующую команду:

```bash
ssh-keygen -t ed25519 -C "github-actions-deploy" -f ~/.ssh/timeweb_polis_root_deploy
```

**Важно:** Не устанавливайте passphrase (оставьте пустым), так как GitHub Actions не сможет использовать ключ с паролем.

Эта команда создаст два файла:
- `~/.ssh/timeweb_deploy` - приватный ключ (будет использоваться в GitHub Secrets)
- `~/.ssh/timeweb_deploy.pub` - публичный ключ (будет добавлен на сервер)

### 1.2 Альтернатива: использование RSA ключа

Если ваш сервер не поддерживает ed25519, используйте RSA:

```bash
ssh-keygen -t rsa -b 4096 -C "github-actions-deploy" -f ~/.ssh/timeweb_deploy
```

### 1.3 Просмотр содержимого ключей

Для просмотра публичного ключа:
```bash
cat ~/.ssh/timeweb_polis_root_deploy.pub
```

Для просмотра приватного ключа:
```bash
cat ~/.ssh/timeweb_polis_root_deploy
```

---

## Шаг 2: Добавление публичного ключа на сервер

### 2.1 Подключение к серверу

Подключитесь к серверу Timeweb Cloud используя существующий метод аутентификации (пароль или существующий ключ):

```bash
ssh root@109.68.215.223
```

### 2.2 Добавление ключа в authorized_keys

На сервере выполните следующие команды:

```bash
# Создать директорию .ssh если её нет
mkdir -p ~/.ssh

# Установить правильные права доступа
chmod 700 ~/.ssh

# Создать или открыть файл authorized_keys
nano ~/.ssh/authorized_keys
```

### 2.3 Вставка публичного ключа

1. Скопируйте содержимое файла `~/.ssh/timeweb_deploy.pub` с вашего локального компьютера
2. Вставьте его в файл `~/.ssh/authorized_keys` на сервере (новая строка)
3. Сохраните файл (Ctrl+O, Enter, Ctrl+X в nano)

### 2.4 Установка правильных прав доступа

```bash
chmod 600 ~/.ssh/authorized_keys
```

### 2.5 Проверка SSH подключения

Откройте новый терминал на локальном компьютере и проверьте подключение:

```bash
ssh -i ~/.ssh/timeweb_deploy root@109.68.215.223
```

Если подключение успешно, вы увидите приглашение командной строки сервера без запроса пароля.

---

## Шаг 3: Настройка GitHub Secrets

### 3.1 Открытие настроек репозитория

1. Откройте ваш репозиторий на GitHub
2. Нажмите на вкладку **Settings** (Настройки)
3. В левом меню найдите раздел **Security** (Безопасность)
4. Нажмите на **Secrets and variables** → **Actions**

### 3.2 Добавление DROPLET_HOST

1. Нажмите кнопку **New repository secret**
2. В поле **Name** введите: `DROPLET_HOST`
3. В поле **Secret** введите: `109.68.215.223`
4. Нажмите **Add secret**

**Визуальная инструкция:**
```
┌─────────────────────────────────────────┐
│ New secret                              │
├─────────────────────────────────────────┤
│ Name *                                  │
│ ┌─────────────────────────────────────┐ │
│ │ DROPLET_HOST                        │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ Secret *                                │
│ ┌─────────────────────────────────────┐ │
│ │ 109.68.215.223                      │ │
│ └─────────────────────────────────────┘ │
│                                         │
│         [Add secret]                    │
└─────────────────────────────────────────┘
```

### 3.3 Добавление DROPLET_USER

1. Нажмите кнопку **New repository secret**
2. В поле **Name** введите: `DROPLET_USER`
3. В поле **Secret** введите: `root` (или имя пользователя, которого вы используете)
4. Нажмите **Add secret**

**Примечание:** Если вы создали отдельного пользователя для развертывания (рекомендуется для безопасности), используйте его имя вместо `root`.

### 3.4 Добавление SSH_PRIVATE_KEY

Это самый важный шаг. Приватный ключ должен быть добавлен полностью, включая заголовки.

1. На локальном компьютере скопируйте **весь** приватный ключ:
   ```bash
   cat ~/.ssh/timeweb_deploy
   ```

2. Скопируйте вывод, который должен выглядеть примерно так:
   ```
   code
   ```

3. На GitHub нажмите **New repository secret**
4. В поле **Name** введите: `SSH_PRIVATE_KEY`
5. В поле **Secret** вставьте **полностью весь** скопированный приватный ключ
6. Нажмите **Add secret**

**Важные моменты:**
- ✅ Включите строки
- ✅ Скопируйте все строки между ними
- ✅ Не добавляйте лишних пробелов или переносов строк
- ❌ Не копируйте публичный ключ (.pub файл) - нужен только приватный ключ

---

## Шаг 4: Проверка настроенных секретов

### 4.1 Просмотр списка секретов

После добавления всех секретов вы должны увидеть их в списке:

```
Repository secrets
┌──────────────────────┬─────────────────┐
│ Name                 │ Updated         │
├──────────────────────┼─────────────────┤
│ DROPLET_HOST         │ 1 minute ago    │
│ DROPLET_USER         │ 2 minutes ago   │
│ SSH_PRIVATE_KEY      │ 3 minutes ago   │
└──────────────────────┴─────────────────┘
```

**Примечание:** GitHub не показывает значения секретов после их создания. Вы можете только обновить или удалить их.

### 4.2 Обновление существующего секрета

Если вам нужно обновить секрет:
1. Найдите секрет в списке
2. Нажмите на него
3. Нажмите **Update secret**
4. Введите новое значение
5. Нажмите **Update secret**

---

## Шаг 5: Тестирование подключения

### 5.1 Ручное тестирование SSH

Перед запуском GitHub Actions workflow, проверьте SSH подключение вручную:

```bash
ssh -i ~/.ssh/timeweb_deploy root@109.68.215.223 "echo 'SSH connection successful'"
```

Ожидаемый результат:
```
SSH connection successful
```

### 5.2 Проверка прав доступа к директории

Убедитесь, что пользователь имеет доступ к директории развертывания:

```bash
ssh -i ~/.ssh/timeweb_deploy root@109.68.215.223 "ls -la ~/insurance_broker"
```

Если директория не существует, создайте её:

```bash
ssh -i ~/.ssh/timeweb_deploy root@109.68.215.223 "mkdir -p ~/insurance_broker"
```

---

## Шаг 6: Запуск тестового развертывания

### 6.1 Триггер GitHub Actions

После настройки всех секретов, вы можете запустить workflow:

1. Перейдите на вкладку **Actions** в репозитории
2. Выберите workflow **Deploy to Production** (или аналогичный)
3. Нажмите **Run workflow**
4. Выберите ветку (обычно `main` или `master`)
5. Нажмите **Run workflow**

### 6.2 Мониторинг выполнения

1. Откройте запущенный workflow
2. Следите за выполнением каждого шага
3. Проверьте логи на наличие ошибок

### 6.3 Типичные ошибки и решения

| Ошибка | Причина | Решение |
|--------|---------|---------|
| `Permission denied (publickey)` | Неверный SSH ключ или он не добавлен на сервер | Проверьте SSH_PRIVATE_KEY и authorized_keys |
| `Host key verification failed` | Сервер не в known_hosts | Добавьте `StrictHostKeyChecking=no` в SSH команду (уже есть в workflow) |
| `Connection refused` | Неверный IP или порт закрыт | Проверьте DROPLET_HOST и firewall на сервере |
| `rsync: command not found` | rsync не установлен на сервере | Установите: `apt-get install rsync` |

---

## Безопасность

### Рекомендации по безопасности

1. **Никогда не коммитьте приватные ключи** в репозиторий
2. **Используйте отдельные ключи** для каждого сервера/окружения
3. **Регулярно ротируйте ключи** (рекомендуется каждые 90 дней)
4. **Ограничьте доступ** к GitHub Secrets только необходимым пользователям
5. **Используйте отдельного пользователя** для развертывания вместо root (опционально)

### Создание отдельного пользователя для развертывания (опционально)

Для повышения безопасности можно создать отдельного пользователя:

```bash
# На сервере
sudo adduser deploy
sudo usermod -aG docker deploy
sudo mkdir -p /home/deploy/.ssh
sudo cp ~/.ssh/authorized_keys /home/deploy/.ssh/
sudo chown -R deploy:deploy /home/deploy/.ssh
sudo chmod 700 /home/deploy/.ssh
sudo chmod 600 /home/deploy/.ssh/authorized_keys
```

Затем обновите `DROPLET_USER` на `deploy` в GitHub Secrets.

---

## Откат изменений

Если что-то пошло не так и нужно вернуться к старому серверу:

### Откат GitHub Secrets

1. Обновите `DROPLET_HOST` на старое значение: `64.227.75.233`
2. Обновите `SSH_PRIVATE_KEY` на старый ключ (если он был изменен)
3. Обновите `DROPLET_USER` на старое значение (если он был изменен)

### Проверка отката

Запустите workflow снова и убедитесь, что развертывание идет на старый сервер.

---

## Следующие шаги

После успешной настройки GitHub Secrets:

1. ✅ Переходите к настройке сервера (см. SERVER_SETUP.md)
2. ✅ Настройте DNS (см. DNS_SSL_SETUP.md)
3. ✅ Выполните миграцию базы данных:
   - Используйте `scripts/migrate-database.sh` для экспорта со старого сервера
   - Используйте `scripts/import-database.sh` для импорта на новый сервер
   - Подробная документация: [docs/DATABASE_MIGRATION_GUIDE.md](docs/DATABASE_MIGRATION_GUIDE.md)
4. ✅ Проведите пост-миграционную проверку (см. POST_MIGRATION_CHECKLIST.md)

---

## Часто задаваемые вопросы

### Q: Могу ли я использовать существующий SSH ключ?

**A:** Да, но рекомендуется создать новый ключ специально для GitHub Actions. Это повышает безопасность и упрощает управление доступом.

### Q: Что делать если я потерял приватный ключ?

**A:** Вам нужно будет сгенерировать новую пару ключей и повторить процесс:
1. Сгенерируйте новую пару ключей
2. Добавьте новый публичный ключ на сервер
3. Обновите SSH_PRIVATE_KEY в GitHub Secrets

### Q: Можно ли использовать пароль вместо SSH ключа?

**A:** Технически возможно, но **крайне не рекомендуется** по соображениям безопасности. SSH ключи намного безопаснее паролей.

### Q: Как проверить, что секреты настроены правильно?

**A:** Запустите workflow и проверьте логи. Если подключение к серверу проходит успешно, секреты настроены правильно.

### Q: Нужно ли удалять старые секреты?

**A:** Нет необходимости удалять старые секреты до тех пор, пока вы не убедитесь, что новый сервер работает стабильно. Сохраните их для возможного отката.

---

## Поддержка

Если у вас возникли проблемы с настройкой GitHub Secrets:

1. Проверьте логи GitHub Actions workflow
2. Проверьте SSH подключение вручную
3. Убедитесь, что все секреты введены без лишних пробелов
4. Проверьте права доступа к файлам на сервере

---

## Чеклист настройки

Используйте этот чеклист для проверки выполнения всех шагов:

- [ ] Сгенерирована новая пара SSH ключей
- [ ] Публичный ключ добавлен в ~/.ssh/authorized_keys на сервере
- [ ] Права доступа к .ssh директории и файлам установлены корректно (700/600)
- [ ] SSH подключение проверено вручную и работает
- [ ] DROPLET_HOST добавлен в GitHub Secrets (109.68.215.223)
- [ ] DROPLET_USER добавлен в GitHub Secrets (root или другой пользователь)
- [ ] SSH_PRIVATE_KEY добавлен в GitHub Secrets (полный ключ с заголовками)
- [ ] Все три секрета видны в списке Repository secrets
- [ ] Тестовое подключение через SSH успешно
- [ ] Директория ~/insurance_broker существует на сервере
- [ ] Готовы к запуску тестового развертывания

---

**Дата создания:** 2024-12-04
**Версия:** 1.0
**Статус:** Готов к использованию
