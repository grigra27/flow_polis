{% extends "analytics/base.html" %}
{% load static %}
{% load currency_filters %}

{% block analytics_title %}Аналитика по клиентам{% endblock %}
{% block title %}Аналитика по клиентам - Система аналитики{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active" aria-current="page">
    <i class="bi bi-people"></i> По клиентам
</li>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/analytics.css' %}">
<style>
    .client-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: box-shadow 0.3s ease;
    }

    .client-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .client-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f0f0f0;
    }

    .client-name {
        font-size: 1.4em;
        font-weight: bold;
        color: #2c3e50;
    }

    .client-inn {
        font-size: 0.9em;
        color: #6c757d;
        margin-top: 5px;
    }

    .rank-badge {
        background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        color: white;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: bold;
    }

    .rank-badge.top-3 {
        background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
    }

    .rank-badge.top-1 {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    }

    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .metric-item {
        text-align: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 6px;
        border-left: 4px solid #27ae60;
    }

    .metric-value {
        font-size: 1.5em;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 5px;
    }

    .metric-label {
        font-size: 0.9em;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .distribution-section {
        margin-top: 20px;
    }

    .distribution-title {
        font-weight: bold;
        margin-bottom: 10px;
        color: #495057;
    }

    .distribution-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #e9ecef;
    }

    .distribution-item:last-child {
        border-bottom: none;
    }

    .distribution-bar {
        width: 60%;
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
        margin-left: 10px;
    }

    .distribution-fill {
        height: 100%;
        background: linear-gradient(90deg, #27ae60, #229954);
        transition: width 0.3s ease;
    }

    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .summary-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        text-align: center;
        border-top: 4px solid #007bff;
    }

    .summary-card.premium { border-top-color: #28a745; }
    .summary-card.commission { border-top-color: #ffc107; }
    .summary-card.policies { border-top-color: #dc3545; }
    .summary-card.clients { border-top-color: #6f42c1; }

    .top-lists-section {
        margin-bottom: 30px;
    }

    .top-list-tabs {
        display: flex;
        border-bottom: 2px solid #e9ecef;
        margin-bottom: 20px;
    }

    .top-list-tab {
        padding: 12px 20px;
        background: none;
        border: none;
        cursor: pointer;
        font-weight: 500;
        color: #6c757d;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
    }

    .top-list-tab.active {
        color: #27ae60;
        border-bottom-color: #27ae60;
    }

    .top-list-content {
        display: none;
    }

    .top-list-content.active {
        display: block;
    }

    .top-client-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        margin-bottom: 10px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-left: 4px solid #27ae60;
    }

    .top-client-info {
        flex: 1;
    }

    .top-client-name {
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 5px;
    }

    .top-client-details {
        font-size: 0.9em;
        color: #6c757d;
    }

    .top-client-value {
        text-align: right;
        font-weight: bold;
        color: #27ae60;
    }

    .top-client-rank {
        background: #27ae60;
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 15px;
    }

    .chart-container {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 30px;
        height: 400px;
    }

    .chart-container canvas {
        max-height: 320px !important;
    }

    .policy-status-filter-enhanced {
        display: flex;
        align-items: center;
        background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);
        padding: 12px 20px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
        border: 2px solid rgba(255, 255, 255, 0.2);
    }

    .policy-status-filter-enhanced .form-label {
        font-weight: 700;
        color: white;
        white-space: nowrap;
        margin-bottom: 0;
        font-size: 14px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .policy-status-filter-enhanced .enhanced-select {
        min-width: 180px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        background: rgba(255, 255, 255, 0.95);
        color: #2c3e50;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .policy-status-filter-enhanced .enhanced-select:focus {
        border-color: #ffffff;
        box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
        background: white;
    }

    .policy-status-filter-enhanced .enhanced-select:hover {
        background: white;
        transform: translateY(-1px);
    }

    .no-data {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
        font-size: 1.1em;
    }

    .no-data i {
        font-size: 3em;
        margin-bottom: 20px;
        color: #dee2e6;
    }

    @media (max-width: 768px) {
        .client-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }

        .metrics-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .summary-cards {
            grid-template-columns: 1fr;
        }

        .chart-container {
            height: 300px;
            padding: 15px;
        }

        .chart-container canvas {
            max-height: 250px !important;
        }

        .top-list-tabs {
            flex-direction: column;
        }

        .top-client-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-users me-2"></i>
                    Аналитика по клиентам
                </h1>
                <div class="d-flex align-items-center gap-3">
                    <div class="policy-status-filter-enhanced">
                        <label for="policyStatus" class="form-label mb-0 me-2">Статус полисов:</label>
                        <select class="form-select form-select-sm enhanced-select" id="policyStatus" onchange="updateAnalytics()">
                            <option value="all" {% if policy_status == 'all' %}selected{% endif %}>Все полисы</option>
                            <option value="active" {% if not policy_status or policy_status == 'active' %}selected{% endif %}>Только активные</option>
                            <option value="inactive" {% if policy_status == 'inactive' %}selected{% endif %}>Только неактивные</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="summary-cards">
        <div class="summary-card premium">
            <div class="metric-value">{{ total_premium_volume|currency }}</div>
            <div class="metric-label">Общий объем премий</div>
        </div>
        <div class="summary-card commission">
            <div class="metric-value">{{ total_commission_revenue|currency }}</div>
            <div class="metric-label">Общая комиссия</div>
        </div>
        <div class="summary-card policies">
            <div class="metric-value">{{ total_policy_count }}</div>
            <div class="metric-label">Всего полисов</div>
        </div>
        <div class="summary-card clients">
            <div class="metric-value">{{ total_clients }}</div>
            <div class="metric-label">Активных клиентов</div>
        </div>
    </div>

    <!-- Charts Section -->
    {% if client_distribution_by_branch or client_distribution_by_insurance_type %}
    <div class="row mb-4">
        {% if client_distribution_by_branch %}
        <div class="col-lg-6">
            <div class="chart-container">
                <h5 class="mb-3">Распределение клиентов по филиалам</h5>
                <canvas id="branchDistributionChart" width="400" height="300"></canvas>
            </div>
        </div>
        {% endif %}

        {% if client_distribution_by_insurance_type %}
        <div class="col-lg-6">
            <div class="chart-container">
                <h5 class="mb-3">Распределение клиентов по видам страхования</h5>
                <canvas id="insuranceTypeDistributionChart" width="400" height="300"></canvas>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Top Lists Section -->
    {% if top_clients_by_insurance_sum or top_clients_by_premium or top_clients_by_commission or top_clients_by_policy_count %}
    <div class="top-lists-section">
        <h4 class="mb-3">Рейтинги клиентов</h4>

        <div class="top-list-tabs">
            <button class="top-list-tab active" onclick="showTopList('insurance_sum')">
                <i class="fas fa-shield-alt me-1"></i>
                По страховой сумме
            </button>
            <button class="top-list-tab" onclick="showTopList('premium')">
                <i class="fas fa-money-bill-wave me-1"></i>
                По страховой премии
            </button>
            <button class="top-list-tab" onclick="showTopList('commission')">
                <i class="fas fa-coins me-1"></i>
                По комиссии
            </button>
            <button class="top-list-tab" onclick="showTopList('policy_count')">
                <i class="fas fa-file-contract me-1"></i>
                По количеству полисов
            </button>
        </div>

        <!-- Top by Insurance Sum -->
        <div id="top-insurance-sum" class="top-list-content active">
            {% for client in top_clients_by_insurance_sum %}
            <div class="top-client-item">
                <div class="top-client-rank">{{ forloop.counter }}</div>
                <div class="top-client-info">
                    <div class="top-client-name">{{ client.client.name }}</div>
                    <div class="top-client-details">
                        {% if client.client.inn %}ИНН: {{ client.client.inn }} | {% endif %}
                        Полисов: {{ client.policy_count }} |
                        Средняя стоимость: {{ client.average_policy_value|currency }}{% if client.primary_branch %} |
                        Филиал: {{ client.primary_branch }}{% endif %}
                    </div>
                </div>
                <div class="top-client-value">
                    <div>{{ client.insurance_sum|currency }}</div>
                    <small class="text-muted">страховая сумма</small>
                </div>
            </div>
            {% empty %}
            <div class="no-data">
                <i class="fas fa-users"></i>
                <div>Нет данных по клиентам</div>
            </div>
            {% endfor %}
        </div>

        <!-- Top by Premium -->
        <div id="top-premium" class="top-list-content">
            {% for client in top_clients_by_premium %}
            <div class="top-client-item">
                <div class="top-client-rank">{{ forloop.counter }}</div>
                <div class="top-client-info">
                    <div class="top-client-name">{{ client.client.name }}</div>
                    <div class="top-client-details">
                        {% if client.client.inn %}ИНН: {{ client.client.inn }} | {% endif %}
                        Полисов: {{ client.policy_count }} |
                        Страховая сумма: {{ client.insurance_sum|currency }}{% if client.primary_branch %} |
                        Филиал: {{ client.primary_branch }}{% endif %}
                    </div>
                </div>
                <div class="top-client-value">
                    <div>{{ client.premium_volume|currency }}</div>
                    <small class="text-muted">страховая премия</small>
                </div>
            </div>
            {% empty %}
            <div class="no-data">
                <i class="fas fa-users"></i>
                <div>Нет данных по клиентам</div>
            </div>
            {% endfor %}
        </div>

        <!-- Top by Commission -->
        <div id="top-commission" class="top-list-content">
            {% for client in top_clients_by_commission %}
            <div class="top-client-item">
                <div class="top-client-rank">{{ forloop.counter }}</div>
                <div class="top-client-info">
                    <div class="top-client-name">{{ client.client.name }}</div>
                    <div class="top-client-details">
                        {% if client.client.inn %}ИНН: {{ client.client.inn }} | {% endif %}
                        Полисов: {{ client.policy_count }} |
                        Премии: {{ client.premium_volume|currency }}{% if client.primary_branch %} |
                        Филиал: {{ client.primary_branch }}{% endif %}
                    </div>
                </div>
                <div class="top-client-value">
                    <div>{{ client.commission_revenue|currency }}</div>
                    <small class="text-muted">комиссия</small>
                </div>
            </div>
            {% empty %}
            <div class="no-data">
                <i class="fas fa-users"></i>
                <div>Нет данных по клиентам</div>
            </div>
            {% endfor %}
        </div>

        <!-- Top by Policy Count -->
        <div id="top-policy-count" class="top-list-content">
            {% for client in top_clients_by_policy_count %}
            <div class="top-client-item">
                <div class="top-client-rank">{{ forloop.counter }}</div>
                <div class="top-client-info">
                    <div class="top-client-name">{{ client.client.name }}</div>
                    <div class="top-client-details">
                        {% if client.client.inn %}ИНН: {{ client.client.inn }} | {% endif %}
                        Страховая сумма: {{ client.insurance_sum|currency }} |
                        Комиссия: {{ client.commission_revenue|currency }}{% if client.primary_branch %} |
                        Филиал: {{ client.primary_branch }}{% endif %}
                    </div>
                </div>
                <div class="top-client-value">
                    <div>{{ client.policy_count }}</div>
                    <small class="text-muted">полисов</small>
                </div>
            </div>
            {% empty %}
            <div class="no-data">
                <i class="fas fa-users"></i>
                <div>Нет данных по клиентам</div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- No Data Message -->
    {% if not top_clients_by_insurance_sum and not top_clients_by_premium and not top_clients_by_commission and not top_clients_by_policy_count %}
    <div class="no-data">
        <i class="fas fa-users"></i>
        <div>Нет данных для отображения</div>
        <small>Попробуйте изменить параметры фильтрации или проверьте наличие данных в системе</small>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize charts
    initializeCharts();
});

function showTopList(listType) {
    // Hide all content
    document.querySelectorAll('.top-list-content').forEach(content => {
        content.classList.remove('active');
    });

    // Remove active class from all tabs
    document.querySelectorAll('.top-list-tab').forEach(tab => {
        tab.classList.remove('active');
    });

    // Show selected content and activate tab
    if (listType === 'insurance_sum') {
        document.getElementById('top-insurance-sum').classList.add('active');
        document.querySelector('[onclick="showTopList(\'insurance_sum\')"]').classList.add('active');
    } else if (listType === 'premium') {
        document.getElementById('top-premium').classList.add('active');
        document.querySelector('[onclick="showTopList(\'premium\')"]').classList.add('active');
    } else if (listType === 'commission') {
        document.getElementById('top-commission').classList.add('active');
        document.querySelector('[onclick="showTopList(\'commission\')"]').classList.add('active');
    } else if (listType === 'policy_count') {
        document.getElementById('top-policy-count').classList.add('active');
        document.querySelector('[onclick="showTopList(\'policy_count\')"]').classList.add('active');
    }
}

// Global chart instances to prevent duplicates
let branchDistributionChart = null;
let insuranceTypeChart = null;
let chartsInitialized = false;

function initializeCharts() {
    // PREVENT MULTIPLE CALLS
    if (chartsInitialized) {
        console.log('Charts already initialized, skipping...');
        return;
    }

    console.log('=== INITIALIZING CHARTS (FIRST TIME) ===');
    chartsInitialized = true;

    {% if client_distribution_by_branch %}
    // Branch distribution chart (pie chart) - COPIED STYLE FROM BRANCH ANALYTICS
    const branchCtx = document.getElementById('branchDistributionChart').getContext('2d');

    // Prepare data
    const branchLabels = [{% for branch, count in client_distribution_by_branch.items %}'{{ branch|default:"Не указан" }}'{% if not forloop.last %},{% endif %}{% endfor %}];
    const branchValues = [{% for branch, count in client_distribution_by_branch.items %}{{ count }}{% if not forloop.last %},{% endif %}{% endfor %}];

    // Use the same colorful palette as before
    const branchColors = [
        '#FF3030', // Bright Red
        '#00CED1', // Dark Turquoise
        '#1E90FF', // Dodger Blue
        '#32CD32', // Lime Green
        '#FFD700', // Gold
        '#DA70D6', // Orchid
        '#00FA9A', // Medium Spring Green
        '#FFA500', // Orange
        '#9370DB', // Medium Purple
        '#00BFFF', // Deep Sky Blue
        '#FF69B4', // Hot Pink
        '#7FFF00', // Chartreuse
        '#FF4500', // Orange Red
        '#20B2AA', // Light Sea Green
        '#BA55D3'  // Medium Orchid
    ];

    // Prepare logo URLs for branches (empty for now, but structure ready)
    const clientBranchLogoUrls = {};
    branchLabels.forEach((label) => {
        clientBranchLogoUrls[label] = null; // No logos available for client analytics
    });

    // Custom legend plugin with logos (COPIED FROM BRANCH ANALYTICS)
    const clientBranchLegendPlugin = {
        id: 'clientBranchLegend',
        beforeInit: function(chart) {
            // Preload legend images (none for client analytics)
            chart.legendImages = {};
            branchLabels.forEach((label) => {
                chart.legendImages[label] = null;
            });
        },
        afterDraw: function(chart) {
            const ctx = chart.ctx;
            const legendArea = chart.legend;

            if (!legendArea || !legendArea.legendItems) return;

            // Clear default legend area
            const legendBox = legendArea.legendHitBoxes;
            if (legendBox && legendBox.length > 0) {
                const startX = legendBox[0].left;
                const startY = legendBox[0].top - 10;
                const width = Math.max(...legendBox.map(box => box.left + box.width)) - startX + 30; // Smaller width without logos
                const height = Math.max(...legendBox.map(box => box.top + box.height)) - startY + 20;

                ctx.clearRect(startX - 10, startY, width, height);

                // Draw custom legend with logos in single column
                const itemHeight = 30;

                legendArea.legendItems.forEach((item, index) => {
                    const x = startX;
                    const y = startY + (index * itemHeight) + 15;

                    // Draw color indicator (small rectangle)
                    ctx.fillStyle = item.fillStyle;
                    ctx.fillRect(x, y - 8, 16, 16);
                    ctx.strokeStyle = '#ccc';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(x, y - 8, 16, 16);

                    // Draw branch name (no logos, just text after rectangle)
                    ctx.fillStyle = '#333';
                    ctx.font = '13px Arial';
                    const branchName = item.text;
                    ctx.fillText(branchName, x + 25, y + 4); // Closer to rectangle

                    // Draw client count (after branch name)
                    const clientCount = branchValues[branchLabels.indexOf(item.text)];
                    const nameWidth = ctx.measureText(branchName).width;
                    ctx.fillStyle = '#666';
                    ctx.font = 'bold 13px Arial';
                    ctx.fillText(' - ' + clientCount + ' клиентов', x + 25 + nameWidth, y + 4);
                });
            }
        }
    };

    const branchData = {
        labels: branchLabels,
        datasets: [{
            label: 'Количество клиентов',
            data: branchValues,
            backgroundColor: branchColors.slice(0, branchLabels.length),
            borderWidth: 2,
            borderColor: '#ffffff'
        }]
    };

    branchDistributionChart = new Chart(branchCtx, {
        type: 'pie',
        data: branchData,
        plugins: [clientBranchLegendPlugin], // Add custom legend plugin
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        padding: 20,
                        usePointStyle: false, // We'll draw custom
                        font: {
                            size: 13
                        },
                        generateLabels: function(chart) {
                            // Generate labels without text (we'll draw custom)
                            return chart.data.labels.map((label, index) => ({
                                text: label,
                                fillStyle: chart.data.datasets[0].backgroundColor[index],
                                hidden: false,
                                index: index
                            }));
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + context.parsed + ' клиентов';
                        }
                    }
                }
            }
        }
    });
    {% endif %}

    {% if client_distribution_by_insurance_type %}
    // Insurance type distribution chart (bar chart)
    const insuranceTypeCtx = document.getElementById('insuranceTypeDistributionChart').getContext('2d');

    const insuranceTypeLabels = [{% for insurance_type, count in client_distribution_by_insurance_type.items %}'{{ insurance_type|default:"Не указан" }}'{% if not forloop.last %},{% endif %}{% endfor %}];
    const insuranceTypeValues = [{% for insurance_type, count in client_distribution_by_insurance_type.items %}{{ count }}{% if not forloop.last %},{% endif %}{% endfor %}];

    // Green monochrome palette for insurance types
    const insuranceTypeColors = [
        '#14532D', '#166534', '#15803D', '#16A34A', '#22C55E',
        '#4ADE80', '#86EFAC', '#BBF7D0', '#DCFCE7', '#F0FDF4'
    ];

    const insuranceTypeData = {
        labels: insuranceTypeLabels,
        datasets: [{
            label: 'Количество клиентов',
            data: insuranceTypeValues,
            backgroundColor: insuranceTypeColors.slice(0, insuranceTypeLabels.length),
            borderColor: insuranceTypeColors.slice(0, insuranceTypeLabels.length),
            borderWidth: 1
        }]
    };

    insuranceTypeChart = new Chart(insuranceTypeCtx, {
        type: 'bar',
        data: insuranceTypeData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            hover: {
                animationDuration: 0
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Клиентов: ' + context.parsed.y;
                        }
                    }
                }
            }
        }
    });
    {% endif %}
}

function updateAnalytics() {
    const policyStatus = document.getElementById('policyStatus').value;
    const url = new URL(window.location);
    url.searchParams.set('policy_status', policyStatus);
    window.location.href = url.toString();
}

function showSuccessMessage(message) {
    // Create and show success alert
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    // Insert at the top of the container
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);

    // Auto-hide after 3 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}
</script>
{% endblock %}
