{% extends "analytics/base.html" %}
{% load static %}
{% load currency_filters %}

{% block analytics_title %}Аналитика по страховщикам{% endblock %}
{% block title %}Аналитика по страховщикам - Система аналитики{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active" aria-current="page">
    <i class="bi bi-building"></i> По страховщикам
</li>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/analytics.css' %}">
<style>
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .summary-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        text-align: center;
        border-top: 4px solid #007bff;
    }

    .summary-card.premium { border-top-color: #28a745; }
    .summary-card.commission { border-top-color: #ffc107; }
    .summary-card.policies { border-top-color: #dc3545; }
    .summary-card.insurers { border-top-color: #6f42c1; }

    .metric-value {
        font-size: 1.5em;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 5px;
    }

    .metric-label {
        font-size: 0.9em;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .chart-container {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 30px;
        height: 400px;
    }

    .chart-container canvas {
        max-height: 320px !important;
    }

    .insurer-table-container {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 30px;
        transition: all 0.3s ease;
    }

    .insurer-table-container.expanded {
        position: fixed;
        top: 20px;
        left: 20px;
        right: 20px;
        bottom: 20px;
        z-index: 1050;
        max-height: calc(100vh - 40px);
        overflow-y: auto;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .insurer-table-container.expanded .table-responsive {
        max-height: calc(100vh - 120px);
        overflow-y: auto;
    }

    .policy-status-filter-enhanced {
        display: flex;
        align-items: center;
        background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);
        padding: 12px 20px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
        border: 2px solid rgba(255, 255, 255, 0.2);
    }

    .policy-status-filter-enhanced .form-label {
        font-weight: 700;
        color: white;
        white-space: nowrap;
        margin-bottom: 0;
        font-size: 14px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .policy-status-filter-enhanced .enhanced-select {
        min-width: 180px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        background: rgba(255, 255, 255, 0.95);
        color: #2c3e50;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .policy-status-filter-enhanced .enhanced-select:focus {
        border-color: #ffffff;
        box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
        background: white;
    }

    .policy-status-filter-enhanced .enhanced-select:hover {
        background: white;
        transform: translateY(-1px);
    }

    .insurer-table {
        margin-bottom: 0;
        font-size: 1.1em;
        border-collapse: separate;
        border-spacing: 0;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
    }

    .insurer-table thead th {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-bottom: 2px solid #e74c3c;
        border-right: 1px solid #dee2e6;
        font-weight: 600;
        font-size: 1em;
        padding: 15px 10px;
        white-space: nowrap;
        color: #495057;
    }

    .insurer-table thead th:last-child {
        border-right: none;
    }

    .insurer-table tbody tr {
        transition: all 0.2s ease;
        border-bottom: 1px solid #dee2e6;
    }

    .insurer-table tbody tr:last-child {
        border-bottom: none;
    }

    .insurer-table tbody tr:hover {
        background-color: #f8f9fa;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .insurer-table tbody tr.top-performer {
        background: linear-gradient(135deg, #fff5f5 0%, #fef7f7 100%);
        border-left: 4px solid #f39c12;
        border-right: 4px solid #f39c12;
        border-top: 2px solid #f39c12;
        border-bottom: 2px solid #f39c12;
    }

    .insurer-table tbody tr.top-performer:hover {
        background: linear-gradient(135deg, #fff0f0 0%, #fef2f2 100%);
    }

    .insurer-table td {
        padding: 15px 10px;
        vertical-align: middle;
        border-right: 1px solid #dee2e6;
    }

    .insurer-table td:last-child {
        border-right: none;
    }

    .insurer-logo-table {
        width: 40px;
        height: 40px;
        object-fit: contain;
        margin-right: 12px;
        border-radius: 6px;
        background: #f8f9fa;
        padding: 3px;
        border: 1px solid #e9ecef;
        flex-shrink: 0;
    }

    .insurer-logo-fallback {
        width: 40px;
        height: 40px;
        margin-right: 12px;
        border-radius: 6px;
        background: #f8f9fa;
        padding: 3px;
        border: 1px solid #e9ecef;
        flex-shrink: 0;
    }

    .insurer-info {
        flex-grow: 1;
    }

    .insurer-name-table {
        font-weight: 600;
        color: #2c3e50;
        font-size: 1.1em;
        line-height: 1.3;
    }

    .leader-badge {
        background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.75em;
        font-weight: 600;
        margin-top: 3px;
        display: inline-block;
    }

    .market-share-wrapper {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .market-share-bar {
        width: 70px;
        height: 10px;
        background: #e9ecef;
        border-radius: 5px;
        overflow: hidden;
        position: relative;
    }

    .market-share-fill {
        height: 100%;
        background: linear-gradient(90deg, #e74c3c, #c0392b);
        transition: width 0.3s ease;
        border-radius: 4px;
    }

    .market-share-text {
        font-weight: 600;
        color: #e74c3c;
        font-size: 1em;
        min-width: 40px;
    }

    .metric-value-table {
        font-weight: 600;
        color: #2c3e50;
        font-size: 1.05em;
    }

    .insurance-types-mini {
        max-height: 90px;
        overflow-y: auto;
        font-size: 0.95em;
    }

    .insurance-type-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 3px 0;
        border-bottom: 1px solid #f1f3f4;
    }

    .insurance-type-item:last-child {
        border-bottom: none;
    }

    .type-name {
        color: #495057;
        flex-grow: 1;
        font-size: 0.9em;
    }

    .type-count {
        background: #e74c3c;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: 600;
        margin-left: 8px;
    }

    .table-controls {
        display: flex;
        gap: 8px;
    }

    /* Column widths */
    .insurer-col { width: 18%; }
    .market-share-col { width: 11%; }
    .premium-col { width: 13%; }
    .commission-col { width: 13%; }
    .policies-col { width: 9%; }
    .insurance-sum-col { width: 13%; }
    .market-share-by-sum-col { width: 11%; }
    .distribution-col { width: 12%; }

    /* Table sorting styles */
    .sortable {
        cursor: pointer;
        user-select: none;
        position: relative;
        transition: background-color 0.2s ease;
    }

    .sortable:hover {
        background-color: #f8f9fa;
    }

    .sort-icon {
        opacity: 0.3;
        font-size: 0.8em;
        transition: all 0.2s ease;
    }

    .sortable:hover .sort-icon {
        opacity: 0.6;
    }

    .sortable.sort-asc .sort-icon {
        opacity: 1;
        color: #007bff;
    }

    .sortable.sort-desc .sort-icon {
        opacity: 1;
        color: #007bff;
    }

    .sortable.sort-asc .sort-icon:before {
        content: "\f0de"; /* fa-sort-up */
    }

    .sortable.sort-desc .sort-icon:before {
        content: "\f0dd"; /* fa-sort-down */
    }

    .sortable.sort-active {
        background-color: #e3f2fd;
    }

    /* Responsive adjustments */
    @media (max-width: 1200px) {
        .insurer-table {
            font-size: 1em;
        }

        .insurer-logo-table {
            width: 36px;
            height: 36px;
        }

        .insurer-logo-fallback {
            width: 36px;
            height: 36px;
        }

        .market-share-bar {
            width: 60px;
        }

        .insurer-name-table {
            font-size: 1em;
        }

        .metric-value-table {
            font-size: 1em;
        }
    }

    @media (max-width: 768px) {
        .insurer-table-container {
            padding: 15px;
        }

        .insurer-table {
            font-size: 0.9em;
        }

        .insurer-table thead th {
            padding: 10px 6px;
            font-size: 0.85em;
        }

        .insurer-table td {
            padding: 10px 6px;
        }

        .insurer-logo-table {
            width: 32px;
            height: 32px;
            margin-right: 8px;
        }

        .insurer-logo-fallback {
            width: 32px;
            height: 32px;
            margin-right: 8px;
        }

        .market-share-bar {
            width: 50px;
            height: 8px;
        }

        .insurance-types-mini {
            max-height: 70px;
            font-size: 0.8em;
        }

        .insurer-name-table {
            font-size: 0.9em;
        }

        .metric-value-table {
            font-size: 0.85em;
        }

        .market-share-text {
            font-size: 0.85em;
        }
    }

    .no-data {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
        font-size: 1.1em;
    }

    .no-data i {
        font-size: 3em;
        margin-bottom: 20px;
        color: #dee2e6;
    }

    .top-performer-badge {
        background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.65em;
        font-weight: 600;
        margin-left: 8px;
        white-space: nowrap;
    }

    @media (max-width: 768px) {
        .insurer-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }

        .metrics-grid {
            grid-template-columns: 1fr;
            gap: 8px;
        }

        .summary-cards {
            grid-template-columns: 1fr;
        }

        .insurer-card {
            padding: 10px;
            margin-bottom: 8px;
        }

        .insurer-name {
            font-size: 0.9em;
        }

        .metric-value {
            font-size: 0.85em;
        }

        .insurer-logo {
            width: 36px;
            height: 36px;
            margin-right: 8px;
        }

        .market-share-badge {
            padding: 3px 8px;
            font-size: 0.7em;
        }

        .metric-block {
            padding: 8px;
        }

        .distribution-item {
            font-size: 0.65em;
        }

        .insurer-list {
            grid-template-columns: 1fr;
            max-height: none;
        }

        .chart-container {
            height: 300px;
            padding: 15px;
        }

        .chart-container canvas {
            max-height: 250px !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-shield-alt me-2"></i>
                    Аналитика по страховщикам
                </h1>
                <div class="d-flex align-items-center gap-3">
                    <div class="policy-status-filter-enhanced">
                        <label for="policyStatus" class="form-label mb-0 me-2">Статус полисов:</label>
                        <select class="form-select form-select-sm enhanced-select" id="policyStatus" onchange="updateAnalytics()">
                            <option value="all" {% if policy_status == 'all' %}selected{% endif %}>Все полисы</option>
                            <option value="active" {% if not policy_status or policy_status == 'active' %}selected{% endif %}>Только активные</option>
                            <option value="inactive" {% if policy_status == 'inactive' %}selected{% endif %}>Только неактивные</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="summary-cards">
        <div class="summary-card premium">
            <div class="metric-value">{{ total_premium_volume|currency }}</div>
            <div class="metric-label">Общий объем премий</div>
        </div>
        <div class="summary-card commission">
            <div class="metric-value">{{ total_commission_revenue|currency }}</div>
            <div class="metric-label">Общая комиссия</div>
        </div>
        <div class="summary-card policies">
            <div class="metric-value">{{ total_policy_count }}</div>
            <div class="metric-label">Всего полисов</div>
        </div>
        <div class="summary-card insurers">
            <div class="metric-value">{{ total_insurers }}</div>
            <div class="metric-label">Активных страховщиков</div>
        </div>
    </div>

    <!-- Charts Section -->
    {% if insurer_metrics %}
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="chart-container">
                <h5 class="mb-3">Рыночная доля по премиям</h5>
                <canvas id="marketShareChart" width="400" height="300"></canvas>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="chart-container">
                <h5 class="mb-3">Рыночная доля по СС</h5>
                <canvas id="marketShareBySumChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- Insurer Details Section -->
    <div class="row">
        <div class="col-12">
            <div class="insurer-table-container">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">
                        <i class="fas fa-shield-alt me-2"></i>
                        Детальная информация по страховщикам
                    </h5>
                    <div class="table-controls">
                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleTableView()">
                            <i class="fas fa-expand-alt me-1"></i>
                            Развернуть
                        </button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table insurer-table">
                        <thead>
                            <tr>
                                <th class="insurer-col sortable" data-sort="text" data-column="insurer_name">
                                    <i class="fas fa-building me-1"></i>
                                    Страховщик
                                    <i class="sort-icon fas fa-sort ms-1"></i>
                                </th>
                                <th class="market-share-col sortable" data-sort="percent" data-column="market_share">
                                    <i class="fas fa-chart-pie me-1"></i>
                                    Доля рынка
                                    <i class="sort-icon fas fa-sort ms-1"></i>
                                </th>
                                <th class="premium-col sortable" data-sort="currency" data-column="premium_volume">
                                    <i class="fas fa-money-bill-wave me-1"></i>
                                    Объем премий
                                    <i class="sort-icon fas fa-sort ms-1"></i>
                                </th>
                                <th class="commission-col sortable" data-sort="currency" data-column="commission_revenue">
                                    <i class="fas fa-percentage me-1"></i>
                                    Комиссия
                                    <i class="sort-icon fas fa-sort ms-1"></i>
                                </th>
                                <th class="policies-col sortable" data-sort="number" data-column="policy_count">
                                    <i class="fas fa-file-contract me-1"></i>
                                    Полисы
                                    <i class="sort-icon fas fa-sort ms-1"></i>
                                </th>
                                <th class="insurance-sum-col sortable" data-sort="currency" data-column="insurance_sum">
                                    <i class="fas fa-shield-alt me-1"></i>
                                    Страх. сумма
                                    <i class="sort-icon fas fa-sort ms-1"></i>
                                </th>
                                <th class="market-share-by-sum-col sortable" data-sort="percent" data-column="market_share_by_sum">
                                    <i class="fas fa-chart-pie me-1"></i>
                                    Доля рынка по СС
                                    <i class="sort-icon fas fa-sort ms-1"></i>
                                </th>
                                <th class="distribution-col sortable" data-sort="text" data-column="insurance_types">
                                    <i class="fas fa-chart-bar me-1"></i>
                                    Виды страхования
                                    <i class="sort-icon fas fa-sort ms-1"></i>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for metric in insurer_metrics %}
                            <tr class="insurer-row {% if forloop.first %}top-performer{% endif %}">
                                <td class="insurer-cell">
                                    <div class="d-flex align-items-center">
                                        {% if metric.insurer.logo %}
                                            <img src="{{ metric.insurer.logo.url }}"
                                                 alt="{{ metric.insurer.insurer_name }}"
                                                 class="insurer-logo-table"
                                                 onerror="this.outerHTML='<div class=&quot;insurer-logo-fallback d-flex align-items-center justify-content-center&quot;><i class=&quot;bi bi-building text-muted&quot; style=&quot;font-size: 14px;&quot;></i></div>';">
                                        {% else %}
                                            <div class="insurer-logo-fallback d-flex align-items-center justify-content-center">
                                                <i class="bi bi-building text-muted" style="font-size: 14px;"></i>
                                            </div>
                                        {% endif %}
                                        <div class="insurer-info">
                                            <div class="insurer-name-table">{{ metric.insurer.insurer_name }}</div>
                                            {% if forloop.first %}
                                                <span class="leader-badge">Лидер рынка</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td class="market-share-cell">
                                    <div class="market-share-wrapper">
                                        <div class="market-share-bar">
                                            <div class="market-share-fill" style="width: {{ metric.market_share|floatformat:1 }}%"></div>
                                        </div>
                                        <span class="market-share-text">{{ metric.market_share|floatformat:1 }}%</span>
                                    </div>
                                </td>
                                <td class="premium-cell">
                                    <div class="metric-value-table">{{ metric.premium_volume|currency }}</div>
                                </td>
                                <td class="commission-cell">
                                    <div class="metric-value-table">{{ metric.commission_revenue|currency }}</div>
                                </td>
                                <td class="policies-cell">
                                    <div class="metric-value-table">{{ metric.policy_count }}</div>
                                </td>
                                <td class="insurance-sum-cell">
                                    <div class="metric-value-table">{{ metric.insurance_sum|currency }}</div>
                                </td>
                                <td class="market-share-by-sum-cell">
                                    <div class="market-share-wrapper">
                                        <div class="market-share-bar">
                                            <div class="market-share-fill" style="width: {{ metric.market_share_by_sum|floatformat:1 }}%"></div>
                                        </div>
                                        <span class="market-share-text">{{ metric.market_share_by_sum|floatformat:1 }}%</span>
                                    </div>
                                </td>
                                <td class="distribution-cell">
                                    {% if metric.insurance_type_distribution %}
                                        <div class="insurance-types-mini">
                                            {% for insurance_type, count in metric.insurance_type_distribution.items %}
                                                <div class="insurance-type-item" title="{{ insurance_type|default:'Не указан' }}: {{ count }} полисов">
                                                    <span class="type-name">{{ insurance_type|default:"Не указан"|truncatechars:15 }}</span>
                                                    <span class="type-count">{{ count }}</span>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Policy Count Chart Section (moved below table) -->
    <div class="row mb-4 justify-content-center">
        <div class="col-lg-7" style="max-width: 60%;">
            <div class="chart-container">
                <h5 class="mb-3">Количество полисов по страховщикам</h5>
                <canvas id="policyChart" width="800" height="300"></canvas>
            </div>
        </div>
    </div>
    {% else %}
    <div class="row">
        <div class="col-12">
            <div class="no-data">
                <i class="fas fa-shield-alt"></i>
                <div>Нет данных для отображения</div>
                <small>Попробуйте изменить параметры фильтрации или проверьте наличие данных в системе</small>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>

// Global chart instances to prevent duplicates
let marketShareChart = null;
let policyChart = null;
let chartsInitialized = false;

function initializeCharts() {
    // PREVENT MULTIPLE CALLS
    if (chartsInitialized) {
        console.log('Charts already initialized, skipping...');
        return;
    }

    console.log('=== INITIALIZING CHARTS (FIRST TIME) ===');
    chartsInitialized = true;
    {% if insurer_metrics %}

    // COMPLETELY CLEAR AND RECREATE CANVAS
    const oldCanvas = document.getElementById('marketShareChart');
    const canvasContainer = oldCanvas.parentNode;

    // Remove old canvas completely
    oldCanvas.remove();

    // Create brand new canvas
    const newCanvas = document.createElement('canvas');
    newCanvas.id = 'marketShareChart';
    newCanvas.width = 400;
    newCanvas.height = 300;
    canvasContainer.appendChild(newCanvas);

    // Get context from new canvas
    const marketShareCtx = newCanvas.getContext('2d');

    // DEBUG: Let's see what data we actually have in metric object
    console.log('=== DEBUGGING METRIC OBJECT ===');
    {% for metric in insurer_metrics %}
    {% if forloop.counter <= 3 %}
    console.log('Metric {{ forloop.counter }}:');
    console.log('  insurer_name: {{ metric.insurer.insurer_name|escapejs }}');
    console.log('  market_share: {{ metric.market_share }}');
    console.log('  premium_volume: {{ metric.premium_volume }}');
    console.log('  policy_count: {{ metric.policy_count }}');
    {% endif %}
    {% endfor %}
    console.log('===============================');

    // Use chart_data_for_pie which has correct values - SAFE PARSING
    const pieData = {
        {% for name, share in chart_data_for_pie.items %}
        '{{ name|escapejs }}': parseFloat('{{ share|floatformat:1 }}'.replace(',', '.')){% if not forloop.last %},{% endif %}
        {% endfor %}
    };

    // Prepare logo URLs for pie chart (TOP-10)
    const pieLogoUrls = {
        {% for metric in insurer_metrics %}
        {% if forloop.counter <= 10 %}
        '{{ metric.insurer.insurer_name|escapejs }}': {% if metric.insurer.logo %}'{{ metric.insurer.logo.url }}'{% else %}null{% endif %}{% if not forloop.last and forloop.counter < 10 %},{% endif %}
        {% endif %}
        {% endfor %}
    };

    // Convert to arrays and take TOP-10
    const allLabelsFromPie = Object.keys(pieData);
    const allValuesFromPie = Object.values(pieData);

    const chartLabels = allLabelsFromPie.slice(0, 10);
    const chartValues = allValuesFromPie.slice(0, 10);

    // DEBUG: Check what's in chart_data_for_pie
    console.log('=== CHART_DATA_FOR_PIE ===');
    {% for name, share in chart_data_for_pie.items %}
    console.log('{{ name|escapejs }}: {{ share }}%');
    {% endfor %}
    console.log('==========================');

    console.log('=== TOP-10 FROM PIE DATA ===');
    console.log('Pie data object:', pieData);
    console.log('Chart labels (TOP-10):', chartLabels);
    console.log('Chart values (TOP-10):', chartValues);
    console.log('Labels length:', chartLabels.length);
    console.log('Values length:', chartValues.length);
    console.log('Canvas element:', newCanvas);
    console.log('============================');

    // Colors for TOP-10 companies - blue monochrome palette (different depths)
    const allColors = [
        '#1E3A8A', '#1D4ED8', '#2563EB', '#3B82F6', '#60A5FA',
        '#93C5FD', '#BFDBFE', '#DBEAFE', '#EBF8FF', '#F0F9FF'
    ];
    const colors = chartLabels.map((label, index) => allColors[index % allColors.length]);

    console.log('Colors assigned:', colors);

    // Custom legend plugin with logos
    const legendWithLogosPlugin = {
        id: 'legendWithLogos',
        beforeInit: function(chart) {
            // Preload legend images
            chart.legendImages = {};
            chartLabels.forEach((label) => {
                const logoUrl = pieLogoUrls[label];
                if (logoUrl) {
                    const img = new Image();
                    img.onload = function() {
                        chart.legendImages[label] = img;
                        chart.update('none');
                    };
                    img.src = logoUrl;
                } else {
                    chart.legendImages[label] = null;
                }
            });
        },
        afterDraw: function(chart) {
            const ctx = chart.ctx;
            const legendArea = chart.legend;

            if (!legendArea || !legendArea.legendItems) return;

            // Clear default legend area
            const legendBox = legendArea.legendHitBoxes;
            if (legendBox && legendBox.length > 0) {
                const startX = legendBox[0].left;
                const startY = legendBox[0].top - 10;
                const width = Math.max(...legendBox.map(box => box.left + box.width)) - startX + 50;
                const height = Math.max(...legendBox.map(box => box.top + box.height)) - startY + 20;

                ctx.clearRect(startX - 10, startY, width, height);

                // Draw custom legend with logos in single column
                const itemHeight = 30;

                legendArea.legendItems.forEach((item, index) => {
                    const x = startX;
                    const y = startY + (index * itemHeight) + 15;

                    // Draw color indicator (small rectangle)
                    ctx.fillStyle = item.fillStyle;
                    ctx.fillRect(x, y - 8, 16, 16);
                    ctx.strokeStyle = '#ccc';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(x, y - 8, 16, 16);

                    // Draw logo if available
                    const img = chart.legendImages[item.text];
                    if (img && img.complete) {
                        ctx.drawImage(img, x + 20, y - 10, 20, 20);
                    } else {
                        // Fallback: draw colored circle
                        ctx.fillStyle = item.fillStyle;
                        ctx.beginPath();
                        ctx.arc(x + 30, y, 8, 0, 2 * Math.PI);
                        ctx.fill();
                    }

                    // Draw company name
                    ctx.fillStyle = '#333';
                    ctx.font = '12px Arial';
                    const companyName = item.text;
                    ctx.fillText(companyName, x + 45, y + 4);

                    // Draw percentage (after company name)
                    const percentage = chartValues[chartLabels.indexOf(item.text)];
                    const nameWidth = ctx.measureText(companyName).width;
                    ctx.fillStyle = '#666';
                    ctx.font = 'bold 12px Arial';
                    ctx.fillText(' - ' + percentage.toFixed(1) + '%', x + 45 + nameWidth, y + 4);
                });
            }
        }
    };

    // Create completely new chart - PIE CHART
    marketShareChart = new Chart(marketShareCtx, {
        type: 'pie',
        data: {
            labels: chartLabels,
            datasets: [{
                label: 'Доля рынка (%)',
                data: chartValues,
                backgroundColor: colors,
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        plugins: [legendWithLogosPlugin], // Add custom legend plugin
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        padding: 20,
                        usePointStyle: false, // We'll draw custom logos
                        font: {
                            size: 12
                        },
                        generateLabels: function(chart) {
                            // Generate labels without text (we'll draw custom)
                            return chart.data.labels.map((label, index) => ({
                                text: label,
                                fillStyle: chart.data.datasets[0].backgroundColor[index],
                                hidden: false,
                                index: index
                            }));
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + context.parsed.toFixed(1) + '%';
                        }
                    }
                }
            }
        }
    });

    // Market Share by Sum Chart (NEW CHART)
    // COMPLETELY CLEAR AND RECREATE CANVAS FOR MARKET SHARE BY SUM
    const oldSumCanvas = document.getElementById('marketShareBySumChart');
    const sumCanvasContainer = oldSumCanvas.parentNode;

    // Remove old canvas completely
    oldSumCanvas.remove();

    // Create brand new canvas
    const newSumCanvas = document.createElement('canvas');
    newSumCanvas.id = 'marketShareBySumChart';
    newSumCanvas.width = 400;
    newSumCanvas.height = 300;
    sumCanvasContainer.appendChild(newSumCanvas);

    // Get context from new canvas
    const marketShareBySumCtx = newSumCanvas.getContext('2d');

    // Prepare insurer data for pie chart by sum (TOP-10)
    const insurerDataBySum = {
        {% for metric in insurer_metrics %}
        {% if forloop.counter <= 10 %}
        '{{ metric.insurer.insurer_name|escapejs }}': parseFloat('{{ metric.market_share_by_sum|floatformat:1 }}'.replace(',', '.')){% if not forloop.last and forloop.counter < 10 %},{% endif %}
        {% endif %}
        {% endfor %}
    };

    // Convert to arrays and take TOP-10
    const allLabelsFromInsurerBySum = Object.keys(insurerDataBySum);
    const allValuesFromInsurerBySum = Object.values(insurerDataBySum);

    const chartLabelsBySum = allLabelsFromInsurerBySum.slice(0, 10);
    const chartValuesBySum = allValuesFromInsurerBySum.slice(0, 10);

    console.log('=== TOP-10 FROM INSURER DATA BY SUM ===');
    console.log('Insurer data by sum object:', insurerDataBySum);
    console.log('Chart labels by sum (TOP-10):', chartLabelsBySum);
    console.log('Chart values by sum (TOP-10):', chartValuesBySum);
    console.log('Canvas element by sum:', newSumCanvas);
    console.log('===============================');

    // Colors for TOP-10 insurers - dark green monochrome palette
    const darkGreenColors = [
        '#14532D', '#166534', '#15803D', '#16A34A', '#22C55E',
        '#4ADE80', '#86EFAC', '#BBF7D0', '#DCFCE7', '#F0FDF4'
    ];
    const colorsBySum = chartLabelsBySum.map((label, index) => darkGreenColors[index % darkGreenColors.length]);

    console.log('Colors assigned by sum:', colorsBySum);

    // Custom legend plugin with logos for sum chart (SAME AS PREMIUM CHART)
    const legendWithLogosPluginBySum = {
        id: 'legendWithLogosBySum',
        beforeInit: function(chart) {
            // Preload legend images
            chart.legendImages = {};
            chartLabelsBySum.forEach((label) => {
                const logoUrl = pieLogoUrls[label];
                if (logoUrl) {
                    const img = new Image();
                    img.onload = function() {
                        chart.legendImages[label] = img;
                        chart.update('none');
                    };
                    img.src = logoUrl;
                } else {
                    chart.legendImages[label] = null;
                }
            });
        },
        afterDraw: function(chart) {
            const ctx = chart.ctx;
            const legendArea = chart.legend;

            if (!legendArea || !legendArea.legendItems) return;

            // Clear default legend area
            const legendBox = legendArea.legendHitBoxes;
            if (legendBox && legendBox.length > 0) {
                const startX = legendBox[0].left;
                const startY = legendBox[0].top - 10;
                const width = Math.max(...legendBox.map(box => box.left + box.width)) - startX + 50;
                const height = Math.max(...legendBox.map(box => box.top + box.height)) - startY + 20;

                ctx.clearRect(startX - 10, startY, width, height);

                // Draw custom legend with logos in single column
                const itemHeight = 30;

                legendArea.legendItems.forEach((item, index) => {
                    const x = startX;
                    const y = startY + (index * itemHeight) + 15;

                    // Draw color indicator (small rectangle)
                    ctx.fillStyle = item.fillStyle;
                    ctx.fillRect(x, y - 8, 16, 16);
                    ctx.strokeStyle = '#ccc';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(x, y - 8, 16, 16);

                    // Draw logo if available
                    const img = chart.legendImages[item.text];
                    if (img && img.complete) {
                        ctx.drawImage(img, x + 20, y - 10, 20, 20);
                    } else {
                        // Fallback: draw colored circle
                        ctx.fillStyle = item.fillStyle;
                        ctx.beginPath();
                        ctx.arc(x + 30, y, 8, 0, 2 * Math.PI);
                        ctx.fill();
                    }

                    // Draw insurer name
                    ctx.fillStyle = '#333';
                    ctx.font = '13px Arial';
                    const insurerName = item.text;
                    ctx.fillText(insurerName, x + 45, y + 4);

                    // Draw percentage (after insurer name)
                    const percentage = chartValuesBySum[chartLabelsBySum.indexOf(item.text)];
                    const nameWidth = ctx.measureText(insurerName).width;
                    ctx.fillStyle = '#666';
                    ctx.font = 'bold 13px Arial';
                    ctx.fillText(' - ' + percentage.toFixed(1) + '%', x + 45 + nameWidth, y + 4);
                });
            }
        }
    };

    // Create completely new chart for market share by sum - PIE CHART
    let marketShareBySumChart = new Chart(marketShareBySumCtx, {
        type: 'pie',
        data: {
            labels: chartLabelsBySum,
            datasets: [{
                label: 'Доля рынка по СС (%)',
                data: chartValuesBySum,
                backgroundColor: colorsBySum,
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        plugins: [legendWithLogosPluginBySum], // Add custom legend plugin
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        padding: 20,
                        usePointStyle: false, // We'll draw custom logos
                        font: {
                            size: 12
                        },
                        generateLabels: function(chart) {
                            // Generate labels without text (we'll draw custom)
                            return chart.data.labels.map((label, index) => ({
                                text: label,
                                fillStyle: chart.data.datasets[0].backgroundColor[index],
                                hidden: false,
                                index: index
                            }));
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            return label + ': ' + value.toFixed(1) + '%';
                        }
                    }
                }
            }
        }
    });

    // Policy count chart (top 10) with logos
    const policyCtx = document.getElementById('policyChart').getContext('2d');

    // Prepare data with logos
    const policyLabels = [{% for metric in insurer_metrics %}{% if forloop.counter <= 10 %}'{{ metric.insurer.insurer_name|escapejs }}'{% if not forloop.last and forloop.counter < 10 %},{% endif %}{% endif %}{% endfor %}];
    const policyValues = [{% for metric in insurer_metrics %}{% if forloop.counter <= 10 %}{{ metric.policy_count }}{% if not forloop.last and forloop.counter < 10 %},{% endif %}{% endif %}{% endfor %}];
    const logoUrls = [{% for metric in insurer_metrics %}{% if forloop.counter <= 10 %}{% if metric.insurer.logo %}'{{ metric.insurer.logo.url }}'{% else %}null{% endif %}{% if not forloop.last and forloop.counter < 10 %},{% endif %}{% endif %}{% endfor %}];

    console.log('Policy chart logos:', logoUrls);

    const policyData = {
        labels: policyLabels,
        datasets: [{
            label: 'Количество полисов',
            data: policyValues,
            backgroundColor: [
                '#1A0B2E', '#2D1B4E', '#4C1D95', '#5B21B6', '#6D28D9',
                '#7C3AED', '#8B5CF6', '#A78BFA', '#C4B5FD', '#DDD6FE'
            ], // Purple-black gradient palette (dark to light)
            borderColor: [
                '#1A0B2E', '#2D1B4E', '#4C1D95', '#5B21B6', '#6D28D9',
                '#7C3AED', '#8B5CF6', '#A78BFA', '#C4B5FD', '#DDD6FE'
            ], // Same colors for borders
            borderWidth: 1
        }]
    };

    // Custom plugin to draw logos - IMPROVED VERSION
    const logoPlugin = {
        id: 'logoPlugin',
        beforeInit: function(chart) {
            // Preload all images
            chart.logoImages = [];
            logoUrls.forEach((logoUrl, index) => {
                if (logoUrl) {
                    const img = new Image();
                    img.onload = function() {
                        chart.logoImages[index] = img;
                        chart.update('none'); // Update without animation
                    };
                    img.src = logoUrl;
                } else {
                    chart.logoImages[index] = null;
                }
            });
        },
        afterDraw: function(chart) {
            const ctx = chart.ctx;
            const xAxis = chart.scales.x;
            const yAxis = chart.scales.y;

            // Draw preloaded logos
            chart.logoImages.forEach((img, index) => {
                if (img && img.complete) {
                    const x = xAxis.getPixelForValue(index);
                    const y = yAxis.bottom + 10;
                    const size = 24;

                    ctx.drawImage(img, x - size/2, y, size, size);
                }
            });
        }
    };

    policyChart = new Chart(policyCtx, {
        type: 'bar',
        data: policyData,
        plugins: [logoPlugin], // Add our custom plugin
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false, // Disable animations to prevent flickering
            hover: {
                animationDuration: 0 // Disable hover animations
            },
            layout: {
                padding: {
                    bottom: 40 // Extra space for logos
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                },
                x: {
                    ticks: {
                        display: false // Hide text labels since we show logos
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return policyLabels[context[0].dataIndex]; // Show company name in tooltip
                        },
                        label: function(context) {
                            return 'Полисов: ' + context.parsed.y;
                        }
                    }
                }
            }
        }
    });
    {% endif %}
}

function toggleTableView() {
    const container = document.querySelector('.insurer-table-container');
    const button = event.target.closest('button');
    const icon = button.querySelector('i');
    const textNode = button.childNodes[button.childNodes.length - 1];

    if (container.classList.contains('expanded')) {
        // Свернуть таблицу
        container.classList.remove('expanded');
        icon.className = 'fas fa-expand-alt me-1';
        textNode.textContent = ' Развернуть';
        document.body.style.overflow = '';

        // Убираем backdrop
        const backdrop = document.querySelector('.table-backdrop');
        if (backdrop) {
            backdrop.remove();
        }
    } else {
        // Развернуть таблицу на весь экран
        container.classList.add('expanded');
        icon.className = 'fas fa-compress-alt me-1';
        textNode.textContent = ' Свернуть';
        document.body.style.overflow = 'hidden';

        // Добавляем backdrop для закрытия по клику вне таблицы
        const backdrop = document.createElement('div');
        backdrop.className = 'table-backdrop';
        backdrop.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1040;
        `;
        backdrop.onclick = () => toggleTableView();
        document.body.appendChild(backdrop);

        // Прокручиваем к началу таблицы
        container.scrollTop = 0;
    }
}

// Table sorting functionality
class TableSorter {
    constructor(tableSelector) {
        this.table = document.querySelector(tableSelector);
        this.tbody = this.table.querySelector('tbody');
        this.headers = this.table.querySelectorAll('th.sortable');
        this.currentSort = { column: null, direction: null };
        this.originalOrder = Array.from(this.tbody.querySelectorAll('tr'));

        this.init();
    }

    init() {
        this.headers.forEach((header, index) => {
            header.addEventListener('click', () => this.handleSort(header, index));
        });
    }

    handleSort(header, columnIndex) {
        const column = header.dataset.column;
        const sortType = header.dataset.sort;

        // Determine sort direction
        let direction = 'asc';
        if (this.currentSort.column === column) {
            if (this.currentSort.direction === 'asc') {
                direction = 'desc';
            } else if (this.currentSort.direction === 'desc') {
                // Third click resets to original order
                this.resetSort();
                return;
            }
        }

        // Update visual indicators
        this.updateSortIndicators(header, direction);

        // Perform sort
        this.sortTable(columnIndex, sortType, direction);

        // Update current sort state
        this.currentSort = { column, direction };
    }

    updateSortIndicators(activeHeader, direction) {
        // Reset all headers
        this.headers.forEach(header => {
            header.classList.remove('sort-asc', 'sort-desc', 'sort-active');
        });

        // Set active header
        activeHeader.classList.add('sort-active', `sort-${direction}`);
    }

    sortTable(columnIndex, sortType, direction) {
        const rows = Array.from(this.tbody.querySelectorAll('tr'));

        rows.sort((a, b) => {
            const aValue = this.getCellValue(a, columnIndex, sortType);
            const bValue = this.getCellValue(b, columnIndex, sortType);

            let comparison = 0;

            if (sortType === 'text') {
                comparison = aValue.localeCompare(bValue, 'ru', { numeric: true });
            } else if (sortType === 'number' || sortType === 'currency' || sortType === 'percent') {
                comparison = aValue - bValue;
            }

            return direction === 'asc' ? comparison : -comparison;
        });

        // Re-append sorted rows
        rows.forEach(row => this.tbody.appendChild(row));
    }

    getCellValue(row, columnIndex, sortType) {
        const cell = row.cells[columnIndex];
        let value = '';

        switch (columnIndex) {
            case 0: // Страховщик
                value = cell.querySelector('.insurer-name-table')?.textContent || '';
                break;
            case 1: // Доля рынка
            case 6: // Доля рынка по СС
                const percentText = cell.querySelector('.market-share-text')?.textContent || '0%';
                value = parseFloat(percentText.replace('%', '').replace(',', '.')) || 0;
                break;
            case 2: // Объем премий
            case 3: // Комиссия
            case 5: // Страх. сумма
                const currencyText = cell.querySelector('.metric-value-table')?.textContent || '0';
                // Remove currency symbols, spaces, and convert to number
                value = parseFloat(currencyText.replace(/[^\d.,]/g, '').replace(',', '.')) || 0;
                break;
            case 4: // Полисы
                const countText = cell.querySelector('.metric-value-table')?.textContent || '0';
                value = parseInt(countText.replace(/\D/g, '')) || 0;
                break;
            case 7: // Виды страхования
                const typesContainer = cell.querySelector('.insurance-types-mini');
                if (typesContainer) {
                    // Sort by number of insurance types
                    value = typesContainer.querySelectorAll('.insurance-type-item').length;
                } else {
                    value = 0;
                }
                break;
            default:
                value = cell.textContent.trim();
        }

        return value;
    }

    resetSort() {
        // Reset visual indicators
        this.headers.forEach(header => {
            header.classList.remove('sort-asc', 'sort-desc', 'sort-active');
        });

        // Restore original order
        this.originalOrder.forEach(row => this.tbody.appendChild(row));

        // Reset current sort state
        this.currentSort = { column: null, direction: null };
    }
}

// Initialize table sorting when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Initialize charts
    initializeCharts();

    // Initialize table sorting
    if (document.querySelector('.insurer-table')) {
        new TableSorter('.insurer-table');
    }

    // Add escape key handler for expanded table
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const container = document.querySelector('.insurer-table-container');
            if (container && container.classList.contains('expanded')) {
                toggleTableView();
            }
        }
    });
});

function updateAnalytics() {
    const policyStatus = document.getElementById('policyStatus').value;
    const url = new URL(window.location);
    url.searchParams.set('policy_status', policyStatus);
    window.location.href = url.toString();
}
</script>
{% endblock %}
