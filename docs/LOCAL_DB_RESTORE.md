# Восстановление локальной базы данных из бэкапа

## Описание

Этот документ описывает процесс восстановления локальной базы данных из бэкапа, который приходит через Telegram.

## Предварительные требования

1. Docker контейнер `local_postgres` должен быть запущен
2. Файл бэкапа должен быть скачан в папку `backups/`

## Процесс восстановления

### 1. Проверка контейнера PostgreSQL

```bash
docker ps --filter "name=local_postgres"
```

Если контейнер не запущен, запустите его:

```bash
docker start local_postgres
```

### 2. Восстановление базы данных

Используйте скрипт `restore-local-docker-db.sh`:

```bash
./scripts/restore-local-docker-db.sh backups/db_backup_YYYYMMDD_HHMMSS.sql
```

Пример:
```bash
./scripts/restore-local-docker-db.sh backups/db_backup_20260127_230003.sql
```

Скрипт выполнит следующие действия:
- Проверит наличие Docker контейнера
- Создаст резервную копию текущей базы (если существует)
- Удалит и пересоздаст базу данных
- Импортирует данные из бэкапа
- Проверит целостность данных

### 3. Применение миграций

После восстановления базы данных запустите миграции Django:

```bash
python manage.py migrate
```

### 4. Запуск сервера разработки

```bash
python manage.py runserver
```

## Что делает скрипт

1. **Проверка контейнера** - убеждается, что PostgreSQL контейнер запущен
2. **Резервное копирование** - создает бэкап текущей базы в `backups/current_db_backup_*.sql`
3. **Подготовка базы** - удаляет старую и создает новую базу данных
4. **Импорт данных** - загружает данные из файла бэкапа
5. **Верификация** - проверяет количество таблиц и записей в ключевых таблицах

## Проверка результата

После восстановления вы увидите статистику:

```
=== Restore Complete ===
Database: insurance_broker_local
Tables: 29
Migrations: 86

  Checking key tables...
  - auth_user: 12 rows
  - policies_policy: 658 rows
  - clients_client: 252 rows
  - insurers_insurer: 16 rows
```

## Устранение проблем

### Контейнер не запущен

```bash
docker start local_postgres
# Подождите несколько секунд
docker ps --filter "name=local_postgres"
```

### Ошибка импорта

Проверьте логи PostgreSQL:

```bash
docker logs local_postgres
```

### База данных не создается

Проверьте подключение:

```bash
docker exec local_postgres psql -U postgres -c '\l'
```

## Автоматизация

Для регулярного тестирования восстановления можно создать cron задачу или использовать скрипт в CI/CD pipeline.

## Безопасность

- Файлы бэкапов содержат чувствительные данные
- Храните их в безопасном месте
- Не коммитьте бэкапы в Git (они уже в `.gitignore`)
- Старые бэкапы автоматически сохраняются с префиксом `current_db_backup_`
